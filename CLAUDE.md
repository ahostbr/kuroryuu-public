## Task Tracking (HARD RULE)

**ALWAYS use Claude Code's native `TaskCreate` tool - NEVER manually write tasks to todo.md!**

```
TaskCreate: subject="Implement feature X" description="Details..."
TaskCreate: subject="Fix bug Y" description="..."
```

The PostToolUse hook automatically syncs tasks to `ai/todo.md` with proper timestamps.

**When complete:** `TaskUpdate: taskId="..." status="completed"` → marks `[x]` with completion timestamp

### Session IDs vs Todo IDs (CRITICAL)

**Session-local task IDs (#1, #2, #3) are NOT the same as ai/todo.md T### IDs (T080, T081).**

- `TaskCreate` returns session-local IDs (#1, #2...) for use with `TaskUpdate` during this session
- The PostToolUse hook assigns the real sequential T### ID (T080, T081...) in `ai/todo.md`
- **When saving checkpoints:** read `ai/todo.md` to find actual T### IDs — NEVER use session #N IDs
- **k_checkpoint `task_id` param:** expects T### format (e.g. "T080"), not "#1"

### Why This Matters
- **Timestamps required for monitoring** - Desktop Gantt timeline needs `(created: timestamp)`
- Tasks without timestamps show "✓" instead of elapsed time in monitor
- Manual edits to todo.md bypass the hook and lose timestamps

### Task Format (Generated by Hook)
```markdown
- [ ] T001: description @agent [worklog: pending] (created: 2026-02-02 12:00)
- [x] T001: description @agent [worklog: path] (created: ...) (completed: 2026-02-02 13:00)
```

**NEVER manually add tasks** - always use TaskCreate so the hook adds proper formatting.

### Monitor Features
- Progress donut chart (pending, in-progress, completed)
- Gantt timeline showing elapsed time per task
- Task list with status badges and worklog links

---

## Checkpoint Rule (HARD RULE)
Always **append to current checkpoint** - do not create new checkpoints each save. Update the existing one.

---

## Search Priority (HARD RULE)
!!!MUST FOLLOW THIS SEARCH PATTERN !!!

!!Use The MCP TOOLS YOU HAVE FIRST THEN > GO IN ORDER TO FALLBACK!!!

!!! Always search in this order: **k_rag → k_repo_intel → git → fallback** !!!

```
1. k_rag          →  Keyword search (fastest, indexed)
2. k_repo_intel   →  Structured reports (symbols, routes, deps)
3. git            →  History, blame, diffs
4. Fallback       →  Glob, Grep, Read, Task agents
```

Check freshness first: `k_rag(action="status")`, `k_repo_intel(action="status")`

---
## Dependency's mapping is a powerful tool for understanding and navigating complex codebases. It allows developers to visualize the relationships between different components, such as functions, classes, and modules. By mapping out these dependencies, developers can identify potential issues, optimize performance, and improve the overall structure of their code.

Kuroryuu Dependency's Mapping Ref:
'Docs\reviews\kuroryuu-dep-map-2026-02-07.md'

## Agent-Initiated TTS (k_tts) (HARD RULE)

**When Ryan says "use TTS", "speak", "say it", "announce", or any variation requesting voice output — ALWAYS use `k_tts`.** This is the canonical TTS workflow. No other method.

```
k_tts(action="speak", text="Build complete, all tests passing.")
k_tts(action="smart", text="Long detailed content...", context="Code review")
```

- **speak**: Direct text-to-speech (fire-and-forget, returns immediately)
- **smart**: AI-summarizes via Gateway first (~20 words), then speaks
- **wait=True**: Block until playback finishes
- Voice: Sonia (en-GB), uses existing TTS queue for overlap prevention
- Smart fallback: if Gateway down, speaks first sentence directly

---

## PTY Reading (HARD RULE)

**Use `max_lines=5-10` for `k_pty term_read`.** Start small, work up only if needed.

Large line reads bloat context and cause unnecessary compaction.

---

## RAG Interactive Mode (Human-in-the-Loop)

Let user select which RAG results to keep before using them.

**Trigger phrases:**
- "search X interactively"
- "rag interactive search X"
- "let me pick the results for X"

**CLI Workflow** (uses AskUserQuestion - works in terminal):
1. Run `k_rag(action="query", query="X", top_k=5)`
2. Present results via `AskUserQuestion` with `multiSelect: true`
3. Question format: `"[query] - Select results to keep:"`
4. Only use the results user selected

**Desktop Workflow** (uses k_interact - requires Kuroryuu Desktop):
- Toggle: "rag interactive on/off/status"
- Runs: `rag-interactive-toggle.ps1`
- Flag file: `.enable-rag-interactive`
- Hook blocks queries → forces `query_interactive` action
- `query_interactive` calls k_interact for GUI selection

---

## Inbox Location

**Canonical Location**: `<PROJECT_ROOT>/ai/inbox`

- Maildir structure: `new/`, `cur/`, `done/`, `dead/`, `tmp/`
- JSON indexes: `.index/by_agent.json`, `.index/by_thread.json`
- Environment override: `KURORYUU_INBOX_ROOT` (optional)

**Messaging Tool:** Use `k_msg` for simplified inter-agent messaging (wraps k_inbox).
- `k_msg(action="send", to="agent_id", subject="...", body="...")`
- `k_msg(action="check", agent_id="my_id")` to poll for messages

MUST REGISTER WITH k_session first for interagent communication.
---

## Claude Task Evidence (Linking Worklogs)

After completing significant work, link your worklog to the task:

1. Find your task in `ai/todo.md` `## Claude Tasks` section
2. Change `[worklog: pending]` → `[worklog: Docs/worklogs/KiroWorkLog_YYYYMMDD_...]`

**Task format:** `- [ ] T###: description @agent [worklog: pending] (created: timestamp)`

**Monitor:** Desktop → MONITOR → Claude Tasks (donut chart + Gantt timeline)

---

## Cross-Reference Rules (HARD RULE)

All persistence artifacts MUST be bidirectionally linked:

### Checkpoint Data Requirements
When saving checkpoints, ALWAYS include:
```json
{
  "plan_file": "Docs/Plans/xxx.md",        // Active plan (or null)
  "worklog_files": ["Docs/worklogs/..."],  // Worklogs this session
  "task_ids": ["T001", "T002"]             // Tasks being worked on
}
```

### Worklog Header Requirements
Every worklog MUST include in header:
```markdown
**Checkpoint:** cp_YYYYMMDD_HHMMSS_xxx
**Plan:** Docs/Plans/xxx.md (or "None")
**Tasks:** T001, T002
```

### Task Format (Updated)
```markdown
- [ ] T###: desc @agent [checkpoint: pending] [worklog: pending] (created: ts)
- [x] T###: desc @agent [checkpoint: cp_...] [worklog: path] (completed: ts)
```

---

## Windows "nul" File Bug (IMPORTANT)

**Problem:** Claude Code's Bash tool runs through Unix-style shell (WSL/Git Bash). When commands use Windows-style null redirection (`> nul` or `2>nul`), bash creates a literal file named "nul" instead of discarding output.

**Symptoms:** 0 KB files named `nul` appearing in project directories.

**Fix for scripts:**
```bash
# WRONG - creates file on Windows bash
command 2>nul

# CORRECT - works in bash
command 2>/dev/null
```

**Cleanup:** Use PowerShell to call WSL (Git Bash mangles the path):
```powershell
powershell.exe -Command "wsl rm -f /mnt/e/path/to/nul"
```

Note: Direct `wsl rm -f "/mnt/e/..."` from Git Bash fails because the path gets converted to `C:/Program Files/Git/mnt/...`

---

# STOP. Read KURORYUU_BOOTSTRAP.md FIRST.

> **Location:** `KURORYUU_BOOTSTRAP.md` (this directory)

## On Session Start

1. Read `KURORYUU_BOOTSTRAP.md` 100% IN FULL !!!
2. Call: `kuroryuu_session_start(process_id, "claude", "your_agent_id")`
3. Confirm: `KURORYUU-aware. Session: {session_id}. Ready.`

##Claude.md Version
2026-02-15
- Added Agent-Initiated TTS section (k_tts: speak + smart actions)

2026-02-11
- Added Session IDs vs Todo IDs section (session #N ≠ ai/todo.md T###)
- Added PTY Reading section
- Added Claude Task Evidence section
- Added Cross-Reference Rules section
- Added Windows "nul" File Bug section
